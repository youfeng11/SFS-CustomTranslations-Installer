package com.youfeng.sfs.ctinstaller.utils

import android.Manifest
import android.content.Context
import android.content.pm.PackageManager
import androidx.core.content.ContextCompat
import com.anggrayudi.storage.SimpleStorage
import com.youfeng.sfs.ctinstaller.core.Constants
import okio.FileSystem
import okio.Path.Companion.toPath

object ExploitFileUtil {
    private val fileSystem = FileSystem.SYSTEM
    private val androidDataPath =
        "${SimpleStorage.externalStoragePath}/${Constants.ANDROID_DATA_DIRECTORY}"

    const val ZWSP = "\u200B"

    val isExploitable: Boolean
        get() {
            return try {
                fileSystem.list(androidDataPath.toPathWithZwsp())
                true
            } catch (_: Exception) {
                false
            }
        }
}

fun String.toPathWithZwsp() =
    replace(
        Constants.ANDROID_DATA_DIRECTORY,
        "${Constants.ANDROID_DATA_DIRECTORY}${ExploitFileUtil.ZWSP}"
    ).toPath()

fun checkStoragePermission(context: Context) = ContextCompat.checkSelfPermission(
    context,
    Manifest.permission.READ_EXTERNAL_STORAGE
) == PackageManager.PERMISSION_GRANTED &&
        ContextCompat.checkSelfPermission(
            context,
            Manifest.permission.WRITE_EXTERNAL_STORAGE
        ) == PackageManager.PERMISSION_GRANTED
